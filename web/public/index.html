<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LAN Clipboard — Web</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .item { border-bottom: 1px solid #ddd; padding: 8px 0; }
      .controls { margin-top: 8px; }
    </style>
  </head>
  <body>
    <h2>LAN Clipboard — Web UI</h2>
    <form id="uploadForm">
      <input type="file" name="file" />
      <button type="submit">上传</button>
    </form>
    <p>或上传文本：</p>
    <form id="uploadTextForm">
      <input type="text" name="text" placeholder="文本内容" />
      <button type="submit">上传文本</button>
    </form>

    <h3>项目</h3>
    <div id="list"></div>

    <script>
      async function load() {
        const res = await fetch('/api/items');
        const items = await res.json();
        const container = document.getElementById('list');
        container.innerHTML = '';
        items.forEach(it => {
          const div = document.createElement('div');
          div.className = 'item';
          if (it.type === 'text') {
            div.innerHTML = `<strong>文本</strong> — ${new Date(it.timestamp).toLocaleString()}<div>${escapeHtml(it.text)}</div>`;
          } else {
            div.innerHTML = `<strong>文件</strong> — ${escapeHtml(it.name)} — ${Math.round(it.size/1024)}KB — ${new Date(it.timestamp).toLocaleString()}`;
          }
          const controls = document.createElement('div');
          controls.className = 'controls';
          const a = document.createElement('a');
          a.href = `/api/download/${it.id}`;
          a.textContent = '下载';
          a.style.marginRight = '10px';
          const b = document.createElement('a');
          b.href = `/api/download/${it.id}?delete=1`;
          b.textContent = '下载后删除';
          b.style.marginRight = '10px';
          const del = document.createElement('button');
          del.textContent = '删除';
          del.addEventListener('click', async () => {
            await fetch(`/api/delete/${it.id}`, { method: 'DELETE' });
            load();
          });
          controls.appendChild(a);
          controls.appendChild(b);
          controls.appendChild(del);
          div.appendChild(controls);
          container.appendChild(div);
        });
      }

      function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const f = e.target.file.files[0];
        if (!f) return alert('请选择文件');
        const form = new FormData();
        form.append('file', f);
        await fetch('/api/upload', { method: 'POST', body: form });
        load();
      });

      document.getElementById('uploadTextForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = e.target.text.value;
        if (!text) return alert('请输入文本');
        const form = new FormData();
        form.append('text', text);
        await fetch('/api/upload', { method: 'POST', body: form });
        e.target.text.value = '';
        load();
      });

      load();
    </script>
  </body>
</html>
